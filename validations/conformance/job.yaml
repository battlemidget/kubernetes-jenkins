# Core validation test for CK

- job:
    name: 'conformance'
    project-type: freestyle
    scm:
      - k8s-jenkins-bm
    parameters:
      !include: global-parameters.yaml
    # triggers:
    #     - timed: "0 12 * * *"
    wrappers:
      - ansicolor
      - workspace-cleanup
    builders:
      - virtualenvwrapper
      - shell: |-
          #!/bin/bash
          set -eux
          cat <<- EOF > $WORKSPACE/deployment.toml

          [Juju.bootstrap]

          constraints = "$JUJU_BOOTSTRAP_CONSTRAINTS"
          debug = "$JUJU_BOOTSTRAP_DEBUG"
          disable_add_model = false

          [Juju.deploy]

          bundle = "$JUJU_DEPLOY_BUNDLE"
          overlay = \"""
          applications:
            kubernetes-master:
              options:
                channel: $SNAP_VERSION
            kubernetes-worker:
              options:
                channel: $SNAP_VERSION
          """
          wait = true
          bundle_channel = "$JUJU_DEPLOY_BUNDLE_CHANNEL"
          charm_channel = "$JUJU_DEPLOY_BUNDLE_CHANNEL"

          [Juju.config]

          set = ["kubernetes-master allow-privileged=true",
                 "kubernetes-worker allow-privileged=true"]
          EOF

          ogc --spec validations/conformance/spec.toml plugin-deps --installable | sh -
          ogc --spec validations/conformance/spec.toml \
              --spec $WORKSPACE/deployment.toml \
              --debug execute
      - virtualenvwrapper-deactivate
