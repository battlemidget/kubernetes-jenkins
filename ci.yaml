# K8s Jenkin GIT repos
- scm:
    name: k8s-jenkins-jenkaas
    scm:
      - git:
          url: https://github.com/charmed-kubernetes/kubernetes-jenkins.git
          branches:
            - 'master'
        skip-tag: true
        fastpoll: true
        shallow-clone: true
        clean: {before: true}

- scm:
    name: k8s-jenkins-bm
    scm:
      - git:
          url: https://github.com/battlemidget/kubernetes-jenkins.git
          branches:
            - 'stokes-ogc'
        skip-tag: true
        fastpoll: true
        shallow-clone: true
        clean: {before: true}

- builder:
    name: charm-build
    builders:
      - shell: |-
          #!/bin/bash
          set -eux
          . /var/lib/jenkins/venvs/ci/bin/activate

          rm -rf "$CHARM_BUILD_DIR" && mkdir -p "$CHARM_BUILD_DIR"
          rm -rf "$CHARM_LAYERS_DIR" && mkdir -p "$CHARM_LAYERS_DIR"
          rm -rf "$CHARM_INTERFACES_DIR" && mkdir -p "$CHARM_INTERFACES_DIR"
          mkdir -p $TMPDIR

          pip install -r"$JOB_SPEC_DIR"/requirements.txt
          ogc --spec "$JOB_SPEC_DIR"/spec.toml --debug execute -t build-charms
          ogc --spec "$JOB_SPEC_DIR"/spec.toml --debug execute -t build-bundles


- builder:
    name: set-env
    builders:
      - shell: |-
          #!/bin/bash
          set -eux

          export VIRTUAL_ENV_DISABLE_PROMPT=1
          export PYTHONPATH="$JOB_SPEC_DIR"
          export CHARM_BUILD_DIR="$WORKSPACE/$CHARM_BUILD_DIR"
          export CHARM_LAYERS_DIR="$WORKSPACE/$CHARM_LAYERS_DIR"
          export CHARM_INTERFACES_DIR="$WORKSPACE/$CHARM_INTERFACES_DIR"
          export TMPDIR="$WORKSPACE/tmp"
          export CHARM_CACHE_DIR=$TMPDIR/.charm
          export GIT_SSH_COMMAND="ssh -i $HOME/.ssh/cdkbot_rsa -oStrictHostKeyChecking=no"
          export PATH=/var/lib/jenkins/venvs/ci/bin:$PATH
          env > $WORKSPACE/build-env.properties

          . /var/lib/jenkins/venvs/ci/bin/activate
          pip install -rrequirements.txt
