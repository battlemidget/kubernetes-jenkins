# K8s Jenkin GIT repos
- scm:
    name: k8s-jenkins-jenkaas
    scm:
      - git:
          url: https://github.com/charmed-kubernetes/kubernetes-jenkins.git
          branches:
            - 'master'
        skip-tag: true
        fastpoll: true
        shallow-clone: true
        clean: {before: true}

- scm:
    name: k8s-jenkins-bm
    scm:
      - git:
          url: https://github.com/battlemidget/kubernetes-jenkins.git
          branches:
            - 'stokes-ogc'
        skip-tag: true
        fastpoll: true
        shallow-clone: true
        clean: {before: true}

- builder:
    name: charm-build
    builders:
      - shell: |-
          #!/bin/bash
          set -eux

          export VIRTUAL_ENV_DISABLE_PROMPT=1
          export PYTHONPATH=builders/charms

          . /var/lib/jenkins/venvs/ci/bin/activate
          pip install -rrequirements.txt

          export CHARM_BUILD_DIR="$WORKSPACE/build/charms"
          export CHARM_LAYERS_DIR="$WORKSPACE/build/layers"
          export CHARM_INTERFACES_DIR="$WORKSPACE/build/interfaces"
          export TMPDIR="$WORKSPACE/tmp"
          export CHARM_CACHE_DIR=$TMPDIR/.charm

          rm -rf "$CHARM_BUILD_DIR" && mkdir -p "$CHARM_BUILD_DIR"
          rm -rf "$CHARM_LAYERS_DIR" && mkdir -p "$CHARM_LAYERS_DIR"
          rm -rf "$CHARM_INTERFACES_DIR" && mkdir -p "$CHARM_INTERFACES_DIR"
          mkdir -p $TMPDIR

          export BUNDLE_LIST="$BUNDLE_LIST"
          export BUNDLE_REPO="$BUNDLE_REPO"
          export CHARM_BRANCH="$CHARM_BRANCH"
          export CHARM_LIST="$CHARM_LIST"
          export FILTER_BY_TAG="$FILTER_BY_TAG"
          export LAYER_BRANCH="$LAYER_BRANCH"
          export LAYER_INDEX="$LAYER_INDEX"
          export LAYER_LIST="$LAYER_LIST"
          export RESOURCE_SPEC="$RESOURCE_SPEC"
          export TO_CHANNEL="$TO_CHANNEL"

          pip install -rbuilders/charms/requirements.txt
          ogc --spec builders/charms/spec.toml --debug execute -t build-charms
          ogc --spec builders/charms/spec.toml --debug execute -t build-bundles

