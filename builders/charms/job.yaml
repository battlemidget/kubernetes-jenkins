# Build charms, bundles, for k8s and kubeflow

- job:
    name: 'build-charms-bundles'
    project-type: freestyle
    scm:
      - k8s-jenkins-bm
    parameters:
      - string:
          name: LAYER_INDEX
          default: 'https://charmed-kubernetes.github.io/layer-index/'
      - string:
          name: LAYER_LIST
      - string:
          name: LAYER_BRANCH
          default: 'master'
          description: |
            The layer git branch to checkout prior to building
      - string:
          name: CHARM_BRANCH
          default: 'master'
          description: |
            The charm git branch to checkout prior to building
      - string:
          name: CHARM_LIST
      - string:
          name: BUNDLE_LIST
      - string:
          name: BUNDLE_REPO
      - string:
          name: RESOURCE_SPEC
      - string:
          name: TO_CHANNEL
          default: 'edge'
          description: Channel to publish charm to
      - string:
          name: TAG
          default: 'k8s'
          description: |
            Filter the builds by tag (ie. k8s). A tag can also be the name of a
            charm you want to individually build.
    triggers:
        - timed: "0 18 * * *"
    wrappers:
      - ansicolor
      - workspace-cleanup
    builders:
      - virtualenvwrapper
      - shell: |-
          #!/bin/bash
          set -eux

          export CHARM_BUILD_DIR = "$WORKSPACE/build/charms"
          export CHARM_LAYERS_DIR = "$WORKSPACE/build/layers"
          export CHARM_INTERFACES_DIR = "$WORKSPACE/build/interfaces"
          export CHARM_CACHE_DIR=$TMPDIR/.charm
          export TMPDIR = "$WORKSPACE/tmp"

          rm -rf "$CHARM_BUILD_DIR" && mkdir -p "$CHARM_BUILD_DIR"
          rm -rf "$CHARM_LAYERS_DIR" && mkdir -p "$CHARM_LAYERS_DIR"
          rm -rf "$CHARM_INTERFACES_DIR" && mkdir -p "$CHARM_INTERFACES_DIR"
          mkdir -p $TMPDIR

          cat <<- EOF > $WORKSPACE/deployment.toml
          [Charm]
          name = "Building Charms"
          description = """
          Build the charms that make up a Juju bundle
          """
          deps = ["snap:charm/latest/edge:classic", "apt:docker.io"]

          [Charm.charms]
          charm_branch = "$CHARM_BRANCH"
          filter_by_tag = "$TAG"
          layer_branch = "$LAYER_BRANCH"
          layer_index = "$LAYER_INDEX"
          layer_list = "$LAYER_LIST"
          list = "$CHARM_LIST"
          resource_spec = "$RESOURCE_SPEC"
          to_channel = "edge"
          add_to_env = ["CHARM_BUILD_DIR",
                        "CHARM_LAYERS_DIR",
                        "CHARM_INTERFACES_DIR",
                        "CHARM_CACHE_DIR",
                        "TMPDIR",
                        "WORKSPACE"]


          [Charm.bundles]
          filter_by_tag = "k8s"
          list = "$BUNDLE_LIST"
          repo = "$BUNDLE_REPO"
          EOF

          ogc --spec builders/charms/spec.toml \
              --spec $WORKSPACE/deployment.toml plugin-deps --installable | sh -
          ogc --spec builders/charms/spec.toml \
              --spec $WORKSPACE/deployment.toml --debug execute -t build-charms
          ogc --spec builders/charms/spec.toml \
              --spec $WORKSPACE/deployment.toml --debug execute -t build-bundles

          # charm build --charm-list includes/charm-support-matrix.inc \
          #      --charm-branch $CHARM_BRANCH \
          #      --to-channel $TO_CHANNEL \
          #      --resource-spec build-charms/resource-spec.yaml \
          #      --filter-by-tag $TAG \
          #      --layer-index $LAYER_INDEX \
          #      --layer-list includes/charm-layer-list.inc \
          #      --layer-branch $LAYER_BRANCH"


          # charm build-bundles --to-channel $TO_CHANNEL \
          #                     --filter-by-tag $TAG \
          #                     --bundle-list includes/charm-bundles-list.inc"

      - virtualenvwrapper-deactivate
