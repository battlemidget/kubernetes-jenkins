# Build snaps

- job:
    name: 'ogc-build-snaps'
    description: |
      Sync all release tags from upstream, then create snap recipes to be built
      and promoted into the snap store.
    project-type: freestyle
    scm:
      - k8s-jenkins-bm
    parameters:
      !include: global-parameters.yaml
      - string:
          name: SNAP_LIST
          default: builders/snaps/k8s-snap-list.yaml
      - string:
          name: PATCHES_LIST
      - bool:
          name: FORCE
          default: false
    wrappers:
      - ansicolor
      - workspace-cleanup
      - credentials-binding:
          - username-password-separated:
              credential-id: k8s_team_ci_lp
              username: K8STEAMCI_USR
              password: K8STEAMCI_PSW
          - file:
              credential-id: launchpad_creds
              variable: LPCREDS
    triggers:
        - timed: "@daily"
    builders:
      - set-env
      - shell: |-
          #!/bin/bash
          set -eux

          TAG="sync"
          if [ ! -z ${PATCHES_LIST+x} ]; then
              TAG="sync-with-patches"
          fi

          . /var/lib/jenkins/venvs/ci/bin/activate

          ogc --spec "$JOB_SPEC_DIR"/"$JOB_SPEC_FILE" plugin-deps --installable | sh -
          ogc --spec "$JOB_SPEC_DIR"/"$JOB_SPEC_FILE" --debug execute -t "$TAG"

- job:
    name: 'ogc-promote-snaps'
    description: |
      Performs a snap promotion
    project-type: freestyle
    scm:
      - k8s-jenkins-bm
    parameters:
      !include: global-parameters.yaml
      - string:
          name: SNAP_LIST
          default: builders/snaps/k8s-snap-list.yaml
      - string:
          name: TO_TRACK
      - string:
          name: FROM_TRACK
      - string:
          name: SNAP_ARCH
    wrappers:
      - ansicolor
      - workspace-cleanup
      - credentials-binding:
          - username-password-separated:
              credential-id: k8s_team_ci_lp
              username: K8STEAMCI_USR
              password: K8STEAMCI_PSW
          - file:
              credential-id: launchpad_creds
              variable: LPCREDS
    triggers:
        - timed: "@daily"
    builders:
      - set-env
      - shell: |-
          #!/bin/bash
          set -eux

          TAG="sync"
          if [ ! -z ${PATCHES_LIST+x} ]; then
              TAG="sync-with-patches"
          fi

          . /var/lib/jenkins/venvs/ci/bin/activate

          ogc --spec "$JOB_SPEC_DIR"/"$JOB_SPEC_FILE" plugin-deps --installable | sh -
          ogc --spec "$JOB_SPEC_DIR"/"$JOB_SPEC_FILE" --debug execute -t "$TAG"
